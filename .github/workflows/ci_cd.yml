# .github/workflows/ci_cd.yml
import nltk
import ssl
name: CI/CT/CD Pipeline for Sentiment Analysis

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      # --- CI STAGE: Setup and Installation ---
      - name: Install Project and Dependencies
        run: pip install -e .

      # ðŸ’¥ NLTK FIX: Download resources using a robust method and set the ENV variable.
      - name: Download NLTK Resources
        run: |
          NLTK_DATA_PATH="/home/runner/nltk_data"
          echo "NLTK_DATA=$NLTK_DATA_PATH" >> $GITHUB_ENV

          # Use a direct Python script with SSL context fix for reliable download
          python -c "

try:
    _create_unverified_https_context = ssl._create_unverified_context
except AttributeError:
    pass
else:
    ssl._create_default_https_context = _create_unverified_https_context

# Force the downloader to look in the target path
nltk.download(['stopwords', 'wordnet', 'punkt'], download_dir='$NLTK_DATA_PATH')
"
          
      # ðŸ’¥ DATA FIX: Prepare data directory (removed redundant 'cp' command)
      - name: Prepare Data Directory
        run: |
          # Ensures the data folder exists. The file is checked out by Git into this folder.
          mkdir -p data 
          echo "Data directory prepared."

      # --- CT STAGE: Train Model ---
      # ðŸ’¥ FINAL NLTK FIX: Explicitly pass the NLTK_DATA environment variable to the training script.
      - name: Run Model Training and Log to MLflow
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # This guarantees the script finds its NLTK data using the explicit path
          NLTK_DATA=/home/runner/nltk_data train_sentiment

      # --- CD STAGE: Build and Deploy Artifact (Docker) ---
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }} # Use the Access Token here

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # The tags line is correct based on your previous input
          tags: ganjidocker/sentiment-analysis-service:latest